html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>éšæœºæŠ½å–å­¦ç”Ÿæˆç»©ç³»ç»Ÿ</title>
    <!-- å¼•å…¥ SheetJSï¼ˆç”¨äºè§£æ Excelï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root{
            --primary:#2b7cff;
            --primary-600:#1f5fd1;
            --accent:#10b981;
            --bg:#f7f9fc;
            --card:#ffffff;
            --text:#1f2937;
            --muted:#6b7280;
            --border:#e5e7eb;
            --danger:#ef4444;
            --warning:#f59e0b;
            --success:#10b981;
            --shadow:0 10px 25px rgba(0,0,0,.08);
            --radius:14px;
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei", sans-serif;
            color:var(--text);
            background:var(--bg);
        }
        .app{
            display:flex;
            height:100%;
            overflow:hidden;
        }
        /* å·¦ä¾§å¯¼èˆª */
        .sidebar{
            width:20%;
            min-width:220px;
            background:linear-gradient(180deg, #1f2a44 0%, #16223a 100%);
            color:#e5ecff;
            display:flex;
            flex-direction:column;
            position:relative;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
        }
        .brand{
            display:flex;
            align-items:center;
            gap:12px;
            padding:22px 20px;
            border-bottom:1px solid rgba(255,255,255,.06);
        }
        .brand .logo{
            width:38px;height:38px;border-radius:10px;
            background: radial-gradient(120% 120% at 0% 0%, #60a5fa 0%, #2563eb 50%, #1d4ed8 100%);
            box-shadow: 0 6px 18px rgba(37,99,235,.45), inset 0 0 20px rgba(255,255,255,.15);
        }
        .brand .title{
            font-weight:700; letter-spacing:.3px; font-size:16px;
        }
        .nav{
            padding:12px 12px;
        }
        .nav button{
            width:100%;
            display:flex;align-items:center;gap:12px;
            padding:12px 14px;
            margin:6px 0;
            background:transparent;
            color:#e5ecff;
            border:none;border-radius:12px;
            cursor:pointer;
            transition:.25s ease;
        }
        .nav button .icon{
            width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;
            color:#93c5fd;
        }
        .nav button:hover{ background:rgba(255,255,255,.06) }
        .nav button.active{
            background:linear-gradient(90deg, rgba(37,99,235,.35), rgba(37,99,235,.18));
            box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
        }
        .sidebar .footer-tip{
            margin-top:auto;
            padding:14px 16px;
            color:#a3b2d8;
            font-size:12px;
            border-top:1px solid rgba(255,255,255,.06);
            opacity:.9;
        }

        /* å³ä¾§å†…å®¹åŒº */
        .content{
            width:80%;
            overflow:auto;
            padding:22px 26px 30px 26px;
        }
        .page{ display:none; animation:fade .25s ease both }
        .page.active{ display:block }
        @keyframes fade{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }

        .card{
            background:var(--card);
            border:1px solid var(--border);
            border-radius:var(--radius);
            box-shadow:var(--shadow);
        }

        /* é¡¶éƒ¨ç­›é€‰åŒº */
        .filters{
            display:flex;flex-wrap:nowrap;gap:16px;align-items:center;
            padding:14px; margin-bottom:16px;
        }
        .filters .field{
            display:flex;flex-direction:column;gap:6px;min-width:120px;
        }
        label{ font-size:12px;color:var(--muted) }
        select, input[type="text"]{
            padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff; outline:none;
            transition:.2s; color:var(--text);
        }
        select:hover, input[type="text"]:hover{ border-color:#cbd5e1 }
        select:focus, input[type="text"]:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(43,124,255,.15) }

        /* æŠ½å–æ¡† */
        .draw-card{ padding:18px; text-align:center }
        .roller{
            position:relative;
            display:inline-block;
            min-width:260px;
            padding:18px 22px;
            border-radius:16px;
            background:linear-gradient(180deg, #f0f6ff 0%, #eaf2ff 100%);
            border:1px solid #dbe7ff;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,.6), 0 10px 25px rgba(43,124,255,.12);
            overflow:hidden;
        }
        .roller .name{
            font-size:36px; font-weight:800; letter-spacing:1px;
            color:var(--primary-600);
            text-shadow:0 1px 0 rgba(255,255,255,.8);
        }
        .roller.rolling .name{
            animation: pulse 1s infinite;
        }
        @keyframes pulse{
            0%{ transform: scale(1) }
            50%{ transform: scale(1.02) }
            100%{ transform: scale(1) }
        }
        .result{
            margin-top:14px;
            display:flex;flex-wrap:wrap;gap:14px;justify-content:center;
        }
        .result .box{
            background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 14px;min-width:160px;
        }
        .result .box h4{ margin:0 0 6px 0; font-size:13px;color:var(--muted) }
        .result .box .val{ font-weight:700; font-size:18px; color:#0f172a }

        .btns{ display:flex;gap:10px;justify-content:center;margin-top:14px;flex-wrap:wrap }
        .btn{
            border:none;border-radius:12px;padding:10px 16px;cursor:pointer;
            background:var(--primary);color:#fff;font-weight:600;
            box-shadow: 0 8px 18px rgba(43,124,255,.28);
            transition:.2s;
        }
        .btn:hover{ filter:brightness(1.05); transform: translateY(-1px) }
        .btn:active{ transform: translateY(0) }
        .btn.secondary{ background:#0ea5e9; box-shadow: 0 8px 18px rgba(14,165,233,.28) }
        .btn.ghost{ background:transparent; color:var(--primary); border:1px solid #c7d7ff }
        .btn.success{ background:var(--success); box-shadow: 0 8px 18px rgba(16,185,129,.28) }
        .btn.warn{ background:var(--warning); box-shadow: 0 8px 18px rgba(245,158,11,.28) }
        .btn.danger{ background:var(--danger); box-shadow: 0 8px 18px rgba(239,68,68,.28) }
        .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none }

        /* æ•°æ®ç®¡ç† */
        .upload{
            padding:16px; display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;
        }
        .upload .area{
            flex:1 1 360px; border:2px dashed #c7d2fe; border-radius:14px; padding:16px; background:#f8faff;
        }
        .upload .hint{ font-size:12px;color:var(--muted) }
        table{
            width:100%; border-collapse:separate; border-spacing:0; margin-top:12px;
        }
        thead th{
            position:sticky; top:0; background:#f3f6fb; z-index:1;
            text-align:left; font-size:12px; color:#64748b; padding:10px; border-bottom:1px solid var(--border);
        }
        tbody td{
            padding:10px; border-bottom:1px solid var(--border); background:#fff;
        }
        tr:hover td{ background:#fafcff }
        .table-wrap{
            max-height:520px; overflow:auto; border-top-left-radius:var(--radius); border-top-right-radius:var(--radius);
        }

        /* ç³»ç»Ÿè®¾ç½® */
        .settings .grid{
            display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:14px; margin-top:12px;
        }
        .setting-card{
            padding:16px; border:1px solid var(--border); border-radius:14px; background:#fff;
            display:flex; flex-direction:column; gap:10px; min-height:140px;
        }
        .setting-card h3{ margin:0; font-size:16px }
        .setting-card p{ margin:0; font-size:12px; color:var(--muted) }

        /* Toast */
        .toast-wrap{
            position:fixed; right:18px; bottom:18px; display:flex; flex-direction:column; gap:10px; z-index:9999;
        }
        .toast{
            background:#111827; color:#fff; padding:10px 14px; border-radius:12px; box-shadow:var(--shadow);
            display:flex; align-items:center; gap:10px; font-size:13px; animation: slideIn .25s ease both;
        }
        .toast.success{ background:#065f46 }
        .toast.error{ background:#7f1d1d }
        @keyframes slideIn{ from{ transform:translateY(10px); opacity:0 } to{ transform:none; opacity:1 } }

        /* å“åº”å¼ */
        @media (max-width: 980px){
            .sidebar{ width:72px; min-width:72px }
            .sidebar .title, .sidebar .nav span.text, .sidebar .footer-tip{ display:none }
            .sidebar .brand{ justify-content:center }
            .sidebar .nav button{ justify-content:center }
            .content{ width:calc(100% - 72px) }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- å·¦ä¾§å¯¼èˆª -->
        <aside class="sidebar">
            <div class="brand">
                <div class="logo" aria-hidden="true"></div>
                <div class="title">éšæœºæŠ½å–ç³»ç»Ÿ</div>
            </div>
            <nav class="nav" role="tablist" aria-label="ä¸»å¯¼èˆª">
                <button class="active" data-page="home" role="tab" aria-selected="true" title="ä¸»é¡µ">
                    <span class="icon">ğŸ </span>
                    <span class="text">ä¸»é¡µ</span>
                </button>
                <button data-page="data" role="tab" aria-selected="false" title="æ•°æ®ç®¡ç†">
                    <span class="icon">ğŸ“Š</span>
                    <span class="text">æ•°æ®ç®¡ç†</span>
                </button>
                <button data-page="settings" role="tab" aria-selected="false" title="ç³»ç»Ÿè®¾ç½®">
                    <span class="icon">&</span>
                    <span class="text">ç³»ç»Ÿè®¾ç½®</span>
                </button>
            </nav>
            <div class="footer-tip">æç¤ºï¼šä»…åœ¨å½“å‰ç­›é€‰çš„ç­çº§å’Œç§‘ç›®èŒƒå›´å†…è¿›è¡ŒæŠ½å–ã€‚</div>
        </aside>

        <!-- å³ä¾§å†…å®¹ -->
        <main class="content" id="app">
            <!-- ä¸»é¡µ -->
            <section id="page-home" class="page active card" role="tabpanel" aria-labelledby="ä¸»é¡µ">
                <div class="filters card">
                    <div class="field">
                        <label for="filter-class">ç­çº§</label>
                        <select id="filter-class" title="é€‰æ‹©ç­çº§"></select>
                    </div>
                    <div class="field">
                        <label for="filter-subject">ç§‘ç›®</label>
                        <select id="filter-subject" title="é€‰æ‹©ç§‘ç›®"></select>
                    </div>
                </div>

                <div class="draw-card card">
                    <div class="roller" id="roller" aria-live="polite" aria-atomic="true">
                        <div class="name" id="current-name">ç­‰å¾…å¼€å§‹</div>
                    </div>
                    <div class="result" id="result">
                        <div class="box"><h4>å§“å</h4><div class="val" id="r-name">-</div></div>
                        <div class="box"><h4>åº§å·</h4><div class="val" id="r-seat">-</div></div>
                        <div class="box"><h4 id="r-subject-label">ç§‘ç›®</h4><div class="val" id="r-score">-</div></div>
                    </div>
                    <div class="btns">
                        <button class="btn" id="btn-start" title="å¼€å§‹éšæœºæŠ½å–">å¼€å§‹</button>
                        <button class="btn ghost" id="btn-stop" disabled title="åœæ­¢å¹¶æ˜¾ç¤ºç»“æœ">åœæ­¢</button>
                    </div>
                </div>
            </section>

            <!-- æ•°æ®ç®¡ç† -->
            <section id="page-data" class="page card" role="tabpanel" aria-labelledby="æ•°æ®ç®¡ç†">
                <div class="upload card">
                    <div class="area">
                        <div class="field" style="max-width:320px">
                            <label for="file">å¯¼å…¥æˆç»©æ–‡ä»¶ï¼ˆExcel/CSVï¼‰</label>
                            <input type="file" id="file" accept=".xlsx,.xls,.csv" title="é€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶"/>
                        </div>
                        <div class="hint">
                            è¡¨å¤´éœ€åŒ…å«ï¼šè€ƒè¯•ç±»å‹ã€ç­çº§ã€å§“åã€åº§å·ã€è¯­æ–‡ã€æ•°å­¦ã€è‹±è¯­ï¼ˆå¯æ‰©å±•å…¶ä»–ç§‘ç›®ï¼‰ã€‚æ”¯æŒå¤šæ¬¡å¯¼å…¥ï¼Œç›¸åŒç­çº§+å§“åçš„æ•°æ®å°†åˆå¹¶ä¸ºè¯¥ç”Ÿçš„å¤šæ¡è®°å½•ã€‚
                        </div>
                    </div>
                    <div style="min-width:220px">
                        <button class="btn success" id="btn-import" title="å¼€å§‹å¯¼å…¥">å¯¼å…¥</button>
                        <button class="btn ghost" id="btn-clear-data" title="æ¸…ç©ºæ‰€æœ‰æ•°æ®">æ¸…ç©ºæ•°æ®</button>
                    </div>
                </div>

                <div class="table-wrap card">
                    <table id="data-table">
                        <thead>
                            <tr>
                                <th>è€ƒè¯•ç±»å‹</th>
                                <th>ç­çº§</th>
                                <th>å§“å</th>
                                <th>åº§å·</th>
                                <th>è¯­æ–‡</th>
                                <th>æ•°å­¦</th>
                                <th>è‹±è¯­</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- ç³»ç»Ÿè®¾ç½® -->
            <section id="page-settings" class="page card" role="tabpanel" aria-labelledby="ç³»ç»Ÿè®¾ç½®">
                <div style="padding:16px">
                    <h3 style="margin:0 0 8px 0">ç³»ç»Ÿè®¾ç½®</h3>
                    <div class="grid settings">
                        <div class="setting-card">
                            <h3>å¤‡ä»½ç³»ç»Ÿ</h3>
                            <p>å¯¼å‡ºæ‰€æœ‰æ•°æ®å’Œè®¾ç½®ä¸º JSON æ–‡ä»¶ã€‚</p>
                            <div style="margin-top:auto">
                                <button class="btn secondary" id="btn-backup" title="å¯¼å‡ºå¤‡ä»½æ–‡ä»¶">å¤‡ä»½ç³»ç»Ÿ</button>
                            </div>
                        </div>
                        <div class="setting-card">
                            <h3>æ¢å¤ç³»ç»Ÿ</h3>
                            <p>ä¸Šä¼ ä¹‹å‰å¤‡ä»½çš„ JSON æ–‡ä»¶ä»¥æ¢å¤æ•°æ®å’Œè®¾ç½®ã€‚</p>
                            <div style="display:flex; gap:8px; margin-top:auto">
                                <input type="file" id="restore-file" accept="application/json" title="é€‰æ‹©å¤‡ä»½æ–‡ä»¶" style="flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:10px"/>
                                <button class="btn" id="btn-restore" title="æ‰§è¡Œæ¢å¤">æ¢å¤ç³»ç»Ÿ</button>
                            </div>
                        </div>
                        <div class="setting-card">
                            <h3>é‡ç½®ç³»ç»Ÿ</h3>
                            <p>æ¸…ç©ºæ‰€æœ‰å¯¼å…¥æ•°æ®å’Œè®¾ç½®ï¼Œæ¢å¤åˆ°åˆå§‹çŠ¶æ€ã€‚</p>
                            <div style="margin-top:auto; display:flex; gap:8px">
                                <button class="btn warn" id="btn-reset" title="é‡ç½®ç³»ç»Ÿ">é‡ç½®ç³»ç»Ÿ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div class="toast-wrap" id="toast-wrap" aria-live="polite" aria-atomic="true"></div>

    <script>
        /* ===== å·¥å…·å‡½æ•° ===== */
        const STORAGE_KEY = 'STUDENT_SYSTEM_DATA_V1';
        const SUBJECTS_DEFAULT = ['è¯­æ–‡','æ•°å­¦','è‹±è¯­'];
        const state = {
            data: [], // {examType, className, name, seat, scores:{subject:score}}
            currentClass: '',
            currentSubject: 'è¯­æ–‡',
            rollingTimer: null,
            currentIndex: -1
        };

        function showToast(msg, type='success'){
            const wrap = document.getElementById('toast-wrap');
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = msg;
            wrap.appendChild(t);
            setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(6px)'; setTimeout(()=>wrap.removeChild(t), 250)}, 2200);
        }

        function saveData(){
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
        }
        function loadData(){
            try{
                const raw = localStorage.getItem(STORAGE_KEY);
                state.data = raw ? JSON.parse(raw) : [];
            }catch(e){
                state.data = [];
            }
        }

        function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36) }

        function detectHeaders(headers){
            // å½’ä¸€åŒ–è¡¨å¤´
            const normalized = headers.map(h=> (h||'').toString().trim().replace(/\s+/g,''));
            const map = {
                examType: normalized.findIndex(h=> ['è€ƒè¯•ç±»å‹','examtype','exam_type','è€ƒè¯•'].some(k=> h.includes(k))),
                className: normalized.findIndex(h=> ['ç­çº§','class','ç­çº§åç§°','ç­çº§å'].some(k=> h.includes(k))),
                name: normalized.findIndex(h=> ['å§“å','name','å­¦ç”Ÿå§“å'].some(k=> h.includes(k))),
                seat: normalized.findIndex(h=> ['åº§å·','åº§ä½å·','è€ƒå·','seat','seatno','seat_no'].some(k=> h.includes(k))),
            };
            // ç§‘ç›®ï¼šé™¤å»ä»¥ä¸Šå­—æ®µåï¼Œå°è¯•è¯†åˆ«æ•°å€¼åˆ—
            const subjectIdx = [];
            normalized.forEach((h,i)=>{
                if([map.examType, map.className, map.name, map.seat].includes(i)) return;
                // å¦‚æœè¯¥åˆ—å¤§éƒ¨åˆ†æ˜¯æ•°å­—ï¼Œåˆ™è§†ä¸ºç§‘ç›®åˆ†æ•°åˆ—
                subjectIdx.push(i);
            });
            return { map, subjectIdx, headers };
        }

        function parseSheet(sheet){
            const json = XLSX.utils.sheet_to_json(sheet, { header:1, defval:'', blankrows:false });
            if(!json.length) return [];
            const headersRow = json[0];
            const { map, subjectIdx } = detectHeaders(headersRow);
            const out = [];
            for(let r=1;r<json.length;r++){
                const row = json[r];
                if(!row || row.every(c=> c==null || c=='')) continue;
                const examType = safeStr(row[map.examType]);
                const className = safeStr(row[map.className]);
                const name = safeStr(row[map.name]);
                const seat = safeStr(row[map.seat]);
                if(!examType || !className || !name || !seat) continue;

                const scores = {};
                subjectIdx.forEach(idx=>{
                    const subj = safeStr(headersRow[idx]) || `ç§‘ç›®${idx+1}`;
                    const val = row[idx];
                    const num = parseFloat(val);
                    if(!Number.isNaN(num)) scores[subj] = num;
                });

                out.push({
                    id: uid(),
                    examType, className, name, seat, scores
                });
            }
            return out;
        }

        function safeStr(v){
            if(v==null) return '';
            return String(v).trim();
        }

        function mergeImported(existing, incoming){
            // æŒ‰ç­çº§+å§“ååˆå¹¶ï¼šå°† incoming ä¸­çš„è®°å½•è¿½åŠ åˆ° existing
            const merged = [...existing];
            incoming.forEach(rec=>{
                merged.push({ ...rec, id: uid() });
            });
            return merged;
        }

        function getClasses(){
            const set = new Set(state.data.map(d=> d.className).filter(Boolean));
            return Array.from(set).sort();
        }

        function getSubjects(){
            // æ”¶é›†æ‰€æœ‰ç§‘ç›®
            const set = new Set();
            state.data.forEach(d=>{
                Object.keys(d.scores||{}).forEach(k=> set.add(k));
            });
            const arr = Array.from(set);
            // é»˜è®¤ä¸‰ç§‘ä¼˜å…ˆæ˜¾ç¤º
            const preferred = SUBJECTS_DEFAULT.filter(s=> arr.includes(s));
            const others = arr.filter(s=> !SUBJECTS_DEFAULT.includes(s));
            return [...preferred, ...others];
        }

        function filterStudentsForDraw(){
            // ä»…åœ¨å½“å‰ç­›é€‰çš„ç­çº§å’Œç§‘ç›®èŒƒå›´å†…
            const cls = state.currentClass;
            const subj = state.currentSubject;
            if(!cls) return [];
            // æ‰¾åˆ°è¯¥ç­çº§ä¸‹æ‰€æœ‰å­¦ç”Ÿï¼ˆå»é‡ï¼‰
            const studentsMap = new Map();
            state.data.forEach(d=>{
                if(d.className!==cls) return;
                if(!studentsMap.has(d.name)){
                    studentsMap.set(d.name, { name:d.name, seat:d.seat, scores:{} });
                }
                // æ±‡æ€»è¯¥ç”Ÿçš„å„ç§‘æˆç»©ï¼ˆå–æœ€æ–°ä¸€æ¡è®°å½•ä¸­çš„è¯¥ç§‘ï¼Ÿè¿™é‡Œç®€å•åˆå¹¶ï¼‰
                const target = studentsMap.get(d.name);
                Object.assign(target.scores, d.scores||{});
            });
            const list = Array.from(studentsMap.values());
            // å¦‚æœé€‰æ‹©çš„ç§‘ç›®ä¸å­˜åœ¨ï¼Œæç¤º
            if(!list.length) return [];
            if(!list[0].scores[subj]){
                // å°è¯•æç¤ºç”¨æˆ·ï¼Œä½†ä¸é˜»æ–­
                showToast(`å½“å‰é€‰æ‹©çš„ç§‘ç›®"${subj}"åœ¨è¯¥ç­çº§æš‚æ— æˆç»©æ•°æ®`, 'error');
            }
            return list;
        }

        /* ===== æ¸²æŸ“ä¸äº¤äº’ ===== */
        const pages = {
            home: document.getElementById('page-home'),
            data: document.getElementById('page-data'),
            settings: document.getElementById('page-settings')
        };

        function switchPage(pageKey){
            Object.values(pages).forEach(p=> p.classList.remove('active'));
            pages[pageKey].classList.add('active');
            document.querySelectorAll('.nav button').forEach(btn=>{
                const active = btn.dataset.page === pageKey;
                btn.classList.toggle('active', active);
                btn.setAttribute('aria-selected', active ? 'true':'false');
            });
            if(pageKey==='data'){
                renderTable();
            }
        }

        function renderFilters(){
            const classSel = document.getElementById('filter-class');
            const subjSel = document.getElementById('filter-subject');

            // ç­çº§
            classSel.innerHTML = '';
            const classes = getClasses();
            classes.forEach(c=>{
                const opt = document.createElement('option');
                opt.value = c; opt.textContent = c;
                classSel.appendChild(opt);
            });
            // ç§‘ç›®
            const renderSubjects = ()=>{
                const subs = getSubjects();
                subjSel.innerHTML = '';
                subs.forEach(s=>{
                    const opt = document.createElement('option');
                    opt.value = s; opt.textContent = s;
                    subjSel.appendChild(opt);
                });
                if(subs.includes(state.currentSubject)){
                    subjSel.value = state.currentSubject;
                }else if(subs[0]){
                    state.currentSubject = subs[0];
                    subjSel.value = subs[0];
                }
                document.getElementById('r-subject-label').textContent = subs[0] ? `${subs[0]}æˆç»©` : 'ç§‘ç›®';
            };
            renderSubjects();

            // åˆå§‹å€¼
            if(classes.includes(state.currentClass)){
                classSel.value = state.currentClass;
            }else if(classes[0]){
                state.currentClass = classes[0];
                classSel.value = classes[0];
            }

            classSel.onchange = ()=>{
                state.currentClass = classSel.value;
                state.currentIndex = -1;
                document.getElementById('current-name').textContent = 'ç­‰å¾…å¼€å§‹';
                document.getElementById('r-name').textContent = '-';
                document.getElementById('r-seat').textContent = '-';
                document.getElementById('r-score').textContent = '-';
            };
            subjSel.onchange = ()=>{
                state.currentSubject = subjSel.value;
                document.getElementById('r-subject-label').textContent = `${subjSel.value}æˆç»©`;
                state.currentIndex = -1;
                document.getElementById('current-name').textContent = 'ç­‰å¾…å¼€å§‹';
                document.getElementById('r-name').textContent = '-';
                document.getElementById('r-seat').textContent = '-';
                document.getElementById('r-score').textContent = '-';
            };
        }

        function startRolling(){
            const list = filterStudentsForDraw();
            if(!list.length){
                showToast('å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰å¯æŠ½å–çš„å­¦ç”Ÿ', 'error');
                return;
            }
            const roller = document.getElementById('roller');
            roller.classList.add('rolling');
            const btnStart = document.getElementById('btn-start');
            const btnStop = document.getElementById('btn-stop');
            btnStart.disabled = true;
            btnStop.disabled = false;

            state.rollingTimer = setInterval(()=>{
                const idx = Math.floor(Math.random()*list.length);
                const s = list[idx];
                document.getElementById('current-name').textContent = s.name;
            }, 90);
        }

        function stopRolling(){
            const list = filterStudentsForDraw();
            if(!list.length) return;
            clearInterval(state.rollingTimer);
            const roller = document.getElementById('roller');
            roller.classList.remove('rolling');
            const btnStart = document.getElementById('btn-start');
            const btnStop = document.getElementById('btn-stop');
            btnStart.disabled = false;
            btnStop.disabled = true;

            const idx = Math.floor(Math.random()*list.length);
            state.currentIndex = idx;
            const s = list[idx];
            document.getElementById('current-name').textContent = s.name;
            document.getElementById('r-name').textContent = s.name;
            document.getElementById('r-seat').textContent = s.seat || '-';
            const score = s.scores[state.currentSubject];
            document.getElementById('r-score').textContent = (score==null) ? '-' : score;
        }

        function renderTable(){
            const tbody = document.querySelector('#data-table tbody');
            tbody.innerHTML = '';
            state.data.forEach(d=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${escapeHtml(d.examType||'')}</td>
                    <td>${escapeHtml(d.className||'')}</td>
                    <td>${escapeHtml(d.name||'')}</td>
                    <td>${escapeHtml(d.seat||'')}</td>
                    <td>${d.scores['è¯­æ–‡']?? '-'}</td>
                    <td>${d.scores['æ•°å­¦']?? '-'}</td>
                    <td>${d.scores['è‹±è¯­']?? '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function escapeHtml(s){
            return (s??'').toString().replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
        }

        async function importFile(file){
            const ext = (file.name.split('.').pop()||'').toLowerCase();
            if(!['xlsx','xls','csv'].includes(ext)){
                showToast('ä»…æ”¯æŒ XLSXã€XLSã€CSV æ ¼å¼', 'error');
                return;
            }
            const buf = await file.arrayBuffer();
            let sheets = [];
            try{
                const wb = XLSX.read(buf, { type:'array' });
                wb.SheetNames.forEach(name=>{
                    const sheet = wb.Sheets[name];
                    sheets = sheets.concat(parseSheet(sheet));
                });
            }catch(e){
                console.error(e);
                showToast('è§£ææ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
                return;
            }
            if(!sheets.length){
                showToast('æœªè§£æåˆ°æœ‰æ•ˆæ•°æ®', 'error');
                return;
            }
            state.data = mergeImported(state.data, sheets);
            saveData();
            showToast(`å¯¼å…¥æˆåŠŸï¼Œå…± ${sheets.length} æ¡è®°å½•`);
            renderFilters();
            renderTable();
        }

        function clearData(){
            if(!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å¯¼å…¥æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
            state.data = [];
            saveData();
            showToast('å·²æ¸…ç©ºæ•°æ®');
            renderFilters();
            renderTable();
            // é‡ç½®æŠ½å–æ˜¾ç¤º
            document.getElementById('current-name').textContent = 'ç­‰å¾…å¼€å§‹';
            document.getElementById('r-name').textContent = '-';
            document.getElementById('r-seat').textContent = '-';
            document.getElementById('r-score').textContent = '-';
        }

        /* ===== ç³»ç»Ÿè®¾ç½®ï¼šå¤‡ä»½/æ¢å¤/é‡ç½® ===== */
        function backupSystem(){
            const payload = {
                version: 1,
                exportAt: new Date().toISOString(),
                data: state.data
            };
            const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `system-backup-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('å¤‡ä»½å·²ä¸‹è½½');
        }

        function restoreSystem(file){
            const reader = new FileReader();
            reader.onload = ()=>{
                try{
                    const payload = JSON.parse(reader.result);
                    if(!payload || !Array.isArray(payload.data)) throw new Error('invalid');
                    state.data = payload.data;
                    saveData();
                    showToast('æ¢å¤æˆåŠŸ');
                    renderFilters();
                    renderTable();
                }catch(e){
                    showToast('æ¢å¤å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼æ— æ•ˆ', 'error');
                }
            };
            reader.readAsText(file);
        }

        function resetSystem(){
            if(!confirm('ç¡®å®šé‡ç½®ç³»ç»Ÿå—ï¼Ÿå°†æ¸…ç©ºæ‰€æœ‰æ•°æ®å¹¶æ¢å¤åˆ°åˆå§‹çŠ¶æ€ã€‚')) return;
            state.data = [];
            saveData();
            showToast('å·²é‡ç½®ç³»ç»Ÿ');
            renderFilters();
            renderTable();
            document.getElementById('current-name').textContent = 'ç­‰å¾…å¼€å§‹';
            document.getElementById('r-name').textContent = '-';
            document.getElementById('r-seat').textContent = '-';
            document.getElementById('r-score').textContent = '-';
        }

        /* ===== åˆå§‹åŒ– ===== */
        function init(){
            loadData();
            renderFilters();

            // å¯¼èˆª
            document.querySelectorAll('.nav button').forEach(btn=>{
                btn.addEventListener('click', ()=> switchPage(btn.dataset.page));
            });

            // ä¸»é¡µæŒ‰é’®
            document.getElementById('btn-start').addEventListener('click', startRolling);
            document.getElementById('btn-stop').addEventListener('click', stopRolling);

            // æ•°æ®ç®¡ç†
            document.getElementById('btn-import').addEventListener('click', async ()=>{
                const input = document.getElementById('file');
                if(!input.files || !input.files[0]){
                    showToast('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                    return;
                }
                await importFile(input.files[0]);
                input.value = '';
            });
            document.getElementById('btn-clear-data').addEventListener('click', clearData);

            // ç³»ç»Ÿè®¾ç½®
            document.getElementById('btn-backup').addEventListener('click', backupSystem);
            document.getElementById('btn-restore').addEventListener('click', ()=>{
                const input = document.getElementById('restore-file');
                if(!input.files || !input.files[0]){
                    showToast('è¯·é€‰æ‹©å¤‡ä»½æ–‡ä»¶', 'error'); return;
                }
                restoreSystem(input.files[0]);
                input.value = '';
            });
            document.getElementById('btn-reset').addEventListener('click', resetSystem);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>